var app=angular.module("branch",["ui.router","ngResource","ngConfirm","ngNotifications","ngComments","ngModeration","ngRating","ngSubscribe","ngSanitize","visualCaptcha"]);app.config(["$stateProvider","$urlRouterProvider","confirmConfigProvider","notificationConfigProvider","commentsConfigProvider","moderationConfigProvider","ratingConfigProvider","subscribeConfigProvider",function(a,b,c,d,e,f,g,h){b.otherwise("/"),a.state("home",{url:"/",templateUrl:"/views/home/index.html",controller:"homeController"}).state("tnc",{url:"/tnc",templateUrl:"/views/tnc/index.html"}).state("noitem",{url:"/noitem",templateUrl:"/views/noitem.html"}).state("badbrowser",{url:"/badbrowser",templateUrl:"/views/badbrowser.html"}).state("loginsignup",{url:"/loginsignup?url",templateUrl:"/views/loginsignup.html",controller:"authController"}).state("login",{url:"/login?url",templateUrl:"/views/login.html",controller:"authController"}).state("reset",{url:"/reset",templateUrl:"/views/reset.html",controller:"authController"}).state("admin",{url:"/admin",templateUrl:"/views/admin/index.html",controller:"adminController"}).state("moderator",{url:"/moderator",templateUrl:"/views/moderator/index.html",controller:"moderatorController"}).state("projects",{url:"/project?terms&page&sort",templateUrl:"/views/projects/index.html",controller:"projectController"}).state("projects.detail",{url:"/:projectId?status",views:{"@":{templateUrl:"/views/projects/detail.html",controller:"projectController"}}}).state("projects.addedit",{url:"/:projectId/edit",views:{"@":{templateUrl:"/views/projects/addedit.html",controller:"projectController"}}}).state("blogs",{url:"/blog",templateUrl:"/views/blogs/index.html",controller:"blogController"}).state("blogs.detail",{url:"/:blogId?status",views:{"@":{templateUrl:"/views/blogs/detail.html",controller:"blogController"}}}).state("blogs.addedit",{url:"/:blogId/edit",views:{"@":{templateUrl:"/views/blogs/addedit.html",controller:"blogController"}}}).state("forum",{url:"/discussion",templateUrl:"/views/forum/index.html",controller:"discussionController"}).state("forum.detail",{url:"/:discussionId?status",views:{"@":{templateUrl:"/views/forum/detail.html",controller:"discussionController"}}}).state("forum.addedit",{url:"/:discussionId/edit",views:{"@":{templateUrl:"/views/forum/addedit.html",controller:"discussionController"}}}).state("users",{url:"/user?sort",templateUrl:"/views/users/index.html",controller:"userController"}).state("users.changepassword",{url:"/changepassword",views:{"@":{templateUrl:"/views/users/changepassword.html",controller:"userController"}}}).state("users.detail",{url:"/:userId",views:{"@":{templateUrl:"/views/users/detail.html",controller:"userController"}}}).state("users.addedit",{url:"/:userId/edit",views:{"@":{templateUrl:"/views/users/addedit.html",controller:"userController"}}}).state("userprofiles",{url:"/userprofile?sort",templateUrl:"/views/users/index.html",controller:"userController"}).state("userprofiles.addedit",{url:"/:userId/edit",views:{"@":{templateUrl:"/views/users/addedit.html",controller:"userController"}}})}]),app.run(["$rootScope",function(a){a.$on("$stateChangeSuccess",function(){document.body.scrollTop=document.documentElement.scrollTop=0})}]),window.WebSocket||(window.location="#badbrowser"),app.directive("header",["userManager","$state","$interpolate",function(a,b,c){return{restrict:"A",replace:!0,scope:{},templateUrl:"/views/header.html",controller:["$scope",function(c){c.userManager=a,c.breadcrumb,c.$on("$stateChangeStart",function(){c.breadcrumb=null}),c.$on("setCrumb",function(a,b){c.breadcrumb=b}),c.getLoginUrl=function(){var a="";return"home"!=b.$current.name&&(a+="?url="),-1==window.location.hash.indexOf("login")&&-1==window.location.hash.indexOf("reset")&&(a+=window.location.hash.replace("#/","")),"#loginsignup"+a}}]}}]),app.directive("footer",["userManager","$state","$interpolate",function(a,b,c){return{restrict:"A",replace:!0,scope:{},templateUrl:"/views/footer.html",controller:["$scope",function(b){b.userManager=a,b.breadcrumb,b.$on("$stateChangeStart",function(){b.breadcrumb=null})}]}}]),app.directive("branchtree",["$interval",function(a){return{restrict:"E",replace:!0,scope:{width:"@",height:"@"},controller:["$scope","$element",function(b,c){function d(a){var b,c,f=e(a);n.push(a),a.d!==s&&(b=r*Math.random()-.5*r,c={i:n.length,x:f.x,y:f.y,a:a.a-p+b,l:a.l*q,d:a.d+1,parent:a.i},d(c),b=r*Math.random()-.5*r,c={i:n.length,x:f.x,y:f.y,a:a.a+p+b,l:a.l*q,d:a.d+1,parent:a.i},d(c))}function e(a){var b=a.x+a.l*Math.sin(a.a),c=a.y-a.l*Math.cos(a.a);return{x:b,y:c}}function f(a){return a.x}function g(a){return a.y}function h(a){return e(a).x}function i(a){return e(a).y}function j(){n=[],d(o),t.selectAll("line").data(n).enter().append("line").style("stroke","#8A8A8A").style("opacity",.6).style("stroke-width",function(a){return parseInt(s+1-a.d)+"px"}).attr("id",function(a){return"id-"+a.i}).transition().duration(500).delay(function(a,b){return 10*b}).attr("x1",f).attr("y1",g).attr("x2",h).attr("y2",i),k=a(u,4e3,30)}var k,l=b.width,m=b.height,n=[],o={i:0,x:l/2,y:m,a:0,l:70,d:0},p=.6,q=.8,r=.4,s=6,t=d3.select(c[0]).append("svg").attr("width",l).attr("height",m),u=function(){n=[],d(o),t.selectAll("line").data(n).transition().duration(2500).attr("x1",f).attr("y1",g).attr("x2",h).attr("y2",i)};j(),b.$on("$destroy",function(){b.$destroy(),b=null,a.cancel(k),c.remove(),c=null,u=null})}]}}]),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngConfirm",[]);return c.provider("confirmConfig",function(){return{$get:function(){return{}}}}),c.factory("confirm",["$rootScope",function(a){return{prompt:function(b,c,d){a.$broadcast("confirmPrompt",{message:b,options:c,callbackFn:d})}}}]),c.directive("confirmDialog",["confirmConfig","$timeout",function(a,b){return{restrict:"E",scope:{},template:function(a,b){return html="<div class='confirm-smokescreen' ng-class='{active:active==true, wide:options.requireComment==true}'>",html+="<div class='confirm-dialog'>",html+="<p>{{message}}</p>",html+="<textarea class='form-control' ng-model='comment' ng-if='options.requireComment'></textarea>",html+="<ul>",html+="<li ng-repeat='option in options.options'><button class='branch-button' ng-click='returnOption($index)'>{{option}}</button></li>",html+="</ul>",html+="</div>",html+="</div>",html},controller:["$scope",function(a){a.$on("confirmPrompt",function(b,c){a.message=c.message,a.options=c.options,a.callback=c.callbackFn,a.active=!0}),a.returnOption=function(b){var c=$(".confirm-dialog textarea").val();a.message=null,a.options=null,a.active=!1,a.callback.call(null,{result:b,comment:c})}}]}}]),c}),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngNotifications",[]);return c.provider("notificationConfig",function(){return{$get:function(){return{}}}}),c.factory("notifications",["$rootScope",function(a){return{notify:function(b,c,d){a.$broadcast("notify",{message:b,list:c,options:d})}}}]),c.directive("notificationDialog",["notificationConfig","$timeout",function(a,b){return{restrict:"E",scope:{},template:function(a,b){return html="<div ng-show='showing' class='{{options.sentiment}} col-md-12 notifications'>",html+="<p>{{message}}</p>",html+="<ul ng-if='list.length>0'>",html+="<li ng-repeat='item in list'>",html+="{{item}}",html+="</li>",html+="</ul>",html+="</div>",html},controller:["$scope",function(a){a.$on("notify",function(b,c){a.showing=!0,a.message=c.message||"",a.list=c.list||[],a.options=c.options||{}})}]}}]),c}),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngComments",[]);return c.provider("commentsConfig",function(){return{$get:function(){return{}}}}),c.factory("comments",["$rootScope",function(a){return{}}]),c.directive("comments",["commentsConfig","$timeout",function(a,b){return{restrict:"A",scope:{entity:"=",entityid:"=",parent:"="},templateUrl:"/views/comments.html",link:["$scope",function(a){}],controller:"commentController"}}]),c}),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngModeration",[]);return c.provider("moderationConfig",function(){return{$get:function(){return{}}}}),c.factory("moderation",["$rootScope",function(a){return{}}]),c.directive("moderation",["moderationConfig","$timeout",function(a,b){return{restrict:"E",replace:!0,scope:{entity:"=",entityid:"=",owner:"=",approved:"=",flagged:"=",flagcount:"=",editable:"=",download:"=",size:"=",orientation:"="},templateUrl:"/views/moderation.html",controller:"moderationController"}}]),c}),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngRating",[]);return c.provider("ratingConfig",function(){return{$get:function(){return{}}}}),c.factory("rating",["$root$scope",function(a){return{}}]),c.directive("rating",["ratingConfig","$resource","$timeout","resultHandler",function(a,b,c,d){return{restrict:"E",replace:!0,scope:{entity:"=",entityid:"=",user:"=",mode:"=",displaystar:"="},templateUrl:"/views/rating.html",controller:["$scope",function(a){var c=b("/api/rating/:ratingId",{ratingId:"@ratingId"});a.$watch("user",function(b,c){a.user&&a.entityid&&"static"!=a.mode&&a.getRating()}),a.$watch("entityid",function(b,c){a.user&&a.entityid&&"static"!=a.mode&&a.getRating()}),a.stars=[1,2,3,4,5],a.displayStar,a.pointsMap={1:-2,2:-1,3:1,4:2,5:3},a.getStar=function(){return a.displaystar?Math.round(a.displaystar):a.myRating&&a.myRating.rating?Math.round(a.myRating.rating):null},a.setDisplayStar=function(b){"static"!=a.mode&&(a.displaystar=b)},a.clearDisplayStar=function(){"static"!=a.mode&&(a.displaystar=null)},a.getRating=function(){c.get({entityId:a.entityid,userid:a.user},function(b){d.process(b)&&(a.myRating=b.data[0]||{})})},a.rate=function(b){var e={};a.myRating&&a.myRating._id?(e.ratingId=a.myRating._id,a.myRating.entityId=a.entityid,a.myRating.rating=b,a.myRating.points=a.pointsMap[b]):a.myRating={entityId:a.entityid,rating:b,points:a.pointsMap[b]},c.save(e,a.myRating,function(a){d.process(a)})}}]}}]),c}),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngSubscribe",[]);return c.provider("subscribeConfig",function(){return{$get:function(){return{}}}}),c.factory("subscribe",["$rootScope",function(a){return{}}]),c.directive("subscribe",["subscribeConfig","$resource","$timeout","resultHandler","notifications",function(a,b,c,d,e){return{restrict:"E",replace:!0,scope:{entity:"=",entityid:"=",user:"="},template:function(a,b){var c="<button class='button-outline' ng-show='user' ng-click='toggleSubscription()' ng-disabled='{{subscribing==true}}'><i class='fa fa-envelope-o'></i>{{buttonText}}</button>";return c},controller:["$scope",function(a){a.buttonText="Please wait...";var c=b("/api/subscription/:subId",{subId:"@subId"});a.$watch("user",function(b,c){a.user&&a.entityid&&a.setup()}),a.$watch("entityid",function(b,c){a.user&&a.entityid&&a.setup()}),a.setup=function(){c.get({entityId:a.entityid,userid:a.user},function(b){d.process(b)&&(a.subscription=b.data[0],a.subscription?a.buttonText="Unsubscribe":a.buttonText="Subscribe")})},a.toggleSubscription=function(){a.subscribing=!0,a.subscription?c["delete"]({subId:a.subscription._id},function(b){a.subscribing=!1,d.process(b)?(e.notify("You have successfully unsubscribed.",null,{sentiment:"positive"}),a.buttonText="Subscribe"):e.notify(b.errText,null,{sentiment:"negative"})}):c.save({entityId:a.entityid,userid:a.user},function(b){a.subscribing=!1,d.process(b)?(a.subscription=b,e.notify("You have successfully subscribed.",null,{sentiment:"positive"}),a.buttonText="Unsubscribe"):e.notify(b.errText,null,{sentiment:"negative"})})}}]}}]),c}),app.directive("searchInput",["$state","$interpolate","confirm",function(a,b,c){return{restrict:"E",replace:!0,$scope:{},templateUrl:"/views/search/search-input.html",controller:["$scope","$element","$attrs",function(a,b,d){$.ajax({type:"GET",dataType:"text",contentType:"application/json",url:"/configs/"+d.config+".json",success:function(b){function e(a,b){var c=a;if(-1!=b.toLowerCase().indexOf(c.toLowerCase()));else if(b.length>c.length)for(;-1==b.toLowerCase().indexOf(c.toLowerCase());)c=c.split(" "),c.splice(0,1),c=c.join(" ");for(;c.length>=b.length&&c.toLowerCase()!=b.toLowerCase();)c=c.split(" "),c.splice(0,1),c=c.join(" ");var d=new RegExp(c,"i");return b.replace(d,"")}a.config=JSON.parse(b);var f=[16,27],g=[9,13,38,40,39,37,32,33,34],h={BACKSPACE:8,ESCAPE:27,TAB:9,ENTER:13,SHIFT:16,UP:38,DOWN:40,RIGHT:39,LEFT:37,DELETE:46,SPACE:32};a.searchText,a.searchTimeout=300,a.suggestTimeout=100,a.searchTimeoutFn,a.suggestTimeoutFn,a.suggesting=!1,a.activeSuggestion=0,a.cursorPosition=0,searchExchange.subscribe("cleared",d.view+".input",function(){a.searchText="",(el=document.getElementById("branch-search-input"))&&(el.value=""),a.cursorPosition=0,a.suggestions=[],a.suggesting=!1,a.activeSuggestion=0,a.ghostPart="",a.ghostQuery="",a.ghostDisplay="",setTimeout(function(){a.preSearch()},0)}),searchExchange.subscribe("reset",d.view+".input",function(){a.searchText="",(el=document.getElementById("branch-search-input"))&&(el.value=""),a.cursorPosition=0,a.suggestions=[],a.suggesting=!1,a.activeSuggestion=0,a.ghostPart="",a.ghostQuery="",a.ghostDisplay=""}),searchExchange.subscribe("suggestResults",d.view+".input",function(b,c){a.suggestions=c.qSuggestions,a.suggestions.splice(5,c.qSuggestions.length-4),a.showSuggestion()}),a.keyDown=function(b){if(b.keyCode==h.ESCAPE)return void a.hideSuggestion();if(b.keyCode==h.DOWN)a.showSuggestion();else if(b.keyCode==h.RIGHT)a.suggesting&&(b.preventDefault(),a.nextSuggestion());else if(b.keyCode==h.LEFT)a.suggesting&&(b.preventDefault(),a.prevSuggestion());else if(b.keyCode==h.ENTER||b.keyCode==h.TAB)a.suggesting&&(b.preventDefault(),a.acceptSuggestion());else if(b.keyCode==h.SPACE){if(5==a.searchText.split(" ").length)return c.prompt("I hate to break it to you but you can only search for 5 things. Must try harder!",{options:["Thanks, I accept this without question"]},function(a){}),b.preventDefault(),!1;if(1==a.searchText.split(" ").pop().length)return c.prompt("You'll need to search for something longer than '"+a.searchText.split(" ").pop()+"'",{options:["That makes sense."]},function(a){}),b.preventDefault(),!1;a.hideSuggestion()}else a.hideSuggestion()},a.keyUp=function(b){a.cursorPosition=b.target.selectionStart,-1==f.indexOf(b.keyCode)&&-1==g.indexOf(b.keyCode)&&(a.searchText&&a.searchText.length>0?a.searchText.split(" ").pop().length>1&&(a.preSearch(),a.preSuggest()):a.clear())},a.nextSuggestion=function(){a.activeSuggestion==a.suggestions.length-1?a.activeSuggestion=0:a.activeSuggestion++,a.drawGhost()},a.prevSuggestion=function(){0==a.activeSuggestion?a.activeSuggestion=a.suggestions.length-1:a.activeSuggestion--,a.drawGhost()},a.hideSuggestion=function(){a.suggesting=!1,a.activeSuggestion=0,a.ghostPart="",a.ghostQuery="",a.ghostDisplay=""},a.showSuggestion=function(){a.searchText&&a.searchText.length>1&&a.cursorPosition==a.searchText.length&&a.suggestions.length>0?(a.suggesting=!0,a.drawGhost()):(a.suggesting=!1,a.removeGhost())},a.setAndAccept=function(b){a.activeSuggestion=b,a.drawGhost(),a.acceptSuggestion()},a.acceptSuggestion=function(){a.searchText=a.ghostQuery,a.suggestions=[],a.hideSuggestion(),a.preSearch()},a.drawGhost=function(){a.ghostPart=e(a.searchText,a.suggestions[a.activeSuggestion].qValue),a.ghostQuery=a.searchText+a.ghostPart,a.ghostDisplay="<span style='color: transparent;'>"+a.searchText+"</span>"+a.ghostPart},a.removeGhost=function(){a.ghostPart=null,a.ghostQuery=null,a.ghostDisplay=null},a.preSuggest=function(){a.searchText.length>1&&a.cursorPosition==a.searchText.length&&(a.suggestTimeoutFn&&clearTimeout(a.suggestTimeoutFn),a.suggestTimeoutFn=setTimeout(function(){searchExchange.suggest(a.searchText,a.config.suggestFields||[])},a.suggestTimeout))},a.preSearch=function(){a.searchTimeoutFn&&clearTimeout(a.searchTimeoutFn),a.searchTimeoutFn=setTimeout(function(){searchExchange.search(a.searchText,a.config.searchFields||[])},a.searchTimeout)},a.clear=function(){searchExchange.clear()},searchExchange.subscribe("executeSearch",d.view+".input",function(){setTimeout(function(){a.searchText="",searchExchange.state&&searchExchange.state&&searchExchange.state.searchText&&(a.searchText=searchExchange.state.searchText,document.getElementById("branch-search-input").value=a.searchText),a.preSearch()},0)}),searchExchange.subscribe("update",d.view+".input",function(){a.searchText||searchExchange.state&&searchExchange.state.searchText&&(a.searchText=searchExchange.state.searchText)})}})}]}}]),app.directive("searchFilter",[function(){return{restrict:"E",replace:!0,scope:{},controller:["$scope","$element","$attrs",function(a,b,c){a.title=c.title,a.handle,a.items,a.toggleValue=function(b){a.$parent.toggleSelect(c.field,b)},a.$on("searchResults",function(){a.handle?a.render():a.postponed=function(){a.render()}}),a.$on("initialising",function(){a.loading=!0}),a.$on("initialised",function(){a.handle?a.render():a.postponed=function(){a.render()}}),searchExchange.subscribe("update",c("id"),function(b){setTimeout(function(){a.handle?a.render():a.postponed=function(){a.render()}},0)}),a.$on("cleared",function(){a.handle?a.render():a.postponed=function(){a.render()}}),a.render=function(){searchExchange.ask(a.handle,"GetLayout",[],function(b){var c=b.result.qLayout;searchExchange.ask(a.handle,"GetListObjectData",["/qListObjectDef",[{qTop:0,qLeft:0,qHeight:c.qListObject.qSize.qcy,qWidth:1}]],function(b){var c=b.result.qDataPages;a.items=c[0].qMatrix,a.$apply()})})},a.selectValue=function(b){searchExchange.ask(a.handle,"SelectListObjectValues",["/qListObjectDef",[b],!0],function(a){searchExchange.render()})},searchExchange.addFilter({id:$(b).$attrs("id"),field:c.field},function(b){a.handle=b.handle,a.postponed&&a.postponed.call(null)})}],templateUrl:"/views/search/search-filter.html"}}]),app.directive("searchResults",["$resource","$state","$stateParams","userManager","resultHandler","publisher",function(a,b,c,d,e,f){return{restrict:"E",replace:!0,scope:{},controller:["$scope","$element","$attrs",function(b,c,f){$.ajax({type:"GET",dataType:"text",contentType:"application/json",url:"/configs/"+f.config+".json",success:function(c){function g(a){setTimeout(function(){searchExchange.state&&searchExchange.state.sort&&(b.sort=searchExchange.state.sort),null!=searchExchange.state&&null!=searchExchange.state.page&&(b.pageTop=b.config.pagesize*searchExchange.state.page),b.handle?a?-1!=a.indexOf(b.handle)&&b.render():b.render():b.postponed=function(){a?-1!=a.indexOf(b.handle)&&b.render():b.render()}},100)}function h(a,c){for(var d=0;d<b.fields.length;d++){if(b.fields[d].dimension&&b.fields[d].dimension==a)return void 0!=c&&0==c?[d]:"["+d+"]";if(b.fields[d].label&&b.fields[d].label==a)return void 0!=c&&0==c?[d]:"["+d+"]"}return 0}function i(a,b){for(var c=0;c<a.options.length;c++)a.options[c].value==b.id?a.options[c].setAttribute("selected",""):a.options[c].removeAttribute("selected")}b.config=JSON.parse(c),b.template=b.config.template,b.fields=b.config.fields,b.qFields,b.sortOptions=b.config.sorting,b.sort=b.sortOptions[b.config.defaultSort],b.elemId=f.id;var j;b.config.entity&&(j=a("/api/"+b.config.entity+"/:id",{id:"@id"})),b.highlightText=function(a){if(searchExchange.state&&searchExchange.state.searchText){for(var b=searchExchange.state.searchText.split(" "),c=0;c<b.length;c++)a=a.replace(new RegExp(b[c],"i"),"<span class='highlight"+c+"'>"+b[c]+"</span>");return a}return a},b.loading=!0,b.items=[],b.hidden=[],b.flagged={},b.stars=new Array(5),b.postponed,b.resultsTemplateCallback,b.pagingTemplateCallback,b.pageTop=0,b.pageBottom=b.config.pagesize,b.currentPage=1,b.pages=[],b.broadcast=function(a,c){b.$root.$broadcast(a,c)},b.getHidden=function(){j&&j.get({id:"hidden"},{limit:100},function(a){e.process(a)&&(b.hidden=a.data)})},b.getFlagged=function(){j&&j.get({id:"flagged"},{limit:100},function(a){if(e.process(a)&&a.data)for(var c=0;c<a.data.length;c++)b.flagged[a.data[c].entityId]=!0})},b.getHidden(),b.getFlagged(),b.isHidden=function(a){for(var c=0;c<b.hidden.length;c++)if(b.hidden[c]._id==a)return!0;return!1},b.isFlagged=function(a){if(b.flagged){for(var c=0;c<b.flagged.length;c++)if(b.flagged[c].entityId==a)return!0;return!1}return!1},searchExchange.subscribe("searching",f.view,function(){b.loading=!0,b.pageTop=0,(el=document.getElementById(f.id+"_loading"))&&(document.getElementById(f.id+"_loading").style.display="block"),(el=document.getElementById(f.id+"_list_container"))&&(document.getElementById(f.id+"_list_container").style.display="none"),(el=document.getElementById(f.id+"_no_results"))&&(document.getElementById(f.id+"_no_results").style.display="none")}),searchExchange.subscribe("noresults",f.view,function(a,c){b.renderEmpty()}),searchExchange.subscribe("update",f.view,function(a,b){g(a)}),searchExchange.subscribe("resume",f.view,function(a,b){g(a)}),b.showItem=function(a,b){return"True"==a||d.canApprove(b)},b.changePage=function(a){b.pageTop+=b.config.pagesize*a,b.render()},b.setPage=function(a){searchExchange.setStateAttr("page",a),b.pageTop=b.config.pagesize*a,b.render()},b.pageInRange=function(a){var c,d;return 1==b.pages.length?!1:(b.currentPage<=2?(c=1,d=5):b.currentPage>=b.pages.length-2?(c=b.pages.length-5,d=b.pages.length):(c=b.currentPage-2,d=b.currentPage+2),a>=c&&d>=a)},b.render=function(){(el=$("#"+f.id).find("._list")[0])&&searchExchange.ask(b.handle,"GetLayout",[],function(a){var c=a.result.qLayout;b.qFields=c.qHyperCube.qDimensionInfo.concat(c.qHyperCube.qMeasureInfo),searchExchange.ask(b.handle,"GetHyperCubeData",["/qHyperCubeDef",[{qTop:b.pageTop,qLeft:0,qHeight:b.config.pagesize,qWidth:b.fields.length}]],function(a){var e=a.result.qDataPages,g=[],h=0;b.$apply(function(){b.loading=!1,b.pageTop=e[0].qArea.qTop,b.pageBottom=e[0].qArea.qTop+e[0].qArea.qHeight,b.currentPage=Math.ceil(b.pageBottom/b.config.pagesize),b.total=c.qHyperCube.qSize.qcy,b.pages=[];for(var a=1;a<Math.ceil(b.total/b.config.pagesize)+1;a++)b.pages.push(a);b.items=[];for(var j={},k={},l={},a=0;a<c.qHyperCube.qMeasureInfo.length;a++)k[c.qHyperCube.qMeasureInfo[a].qFallbackTitle]=c.qHyperCube.qMeasureInfo[a].qMax,l[c.qHyperCube.qMeasureInfo[a].qFallbackTitle]=c.qHyperCube.qMeasureInfo[a].qMin,j[c.qHyperCube.qMeasureInfo[a].qFallbackTitle]=c.qHyperCube.qGrandTotalRow[a].qNum;for(var a=0;a<e[0].qMatrix.length;a++){var m={};if(null==b.config.nullSuppressor||"-"!=e[0].qMatrix[a][b.config.nullSuppressor].qText){for(var n=0;n<e[0].qMatrix[a].length;n++)m[b.qFields[n].qFallbackTitle]=e[0].qMatrix[a][n].qText;if("-"!=m.rating){m.stars=[];for(var o=parseInt(m.rating),p=0;o>p;p++)m.stars.push(p)}m.hidden=b.isHidden(m[b.config.primaryKey]),m.hidden&&h++,g.push(m)}}var q=$("#"+f.id).find("._sort")[0];if(i(q,b.sort),h==g.length){if(!d.hasUser)return void b.renderEmpty();if(!d.canApprove(b.entity))return void b.renderEmpty()}if(g.length>0){b.loading=!1,b.items=g;var r=[];searchExchange.state&&searchExchange.state.searchText&&(r=searchExchange.state.searchText.split(" ")),$("#"+f.id).find("._count_label")[0].innerHTML="Showing "+(b.pageTop+1)+" - "+b.pageBottom+" of "+b.total+" results",b.resultsTemplate?$("#"+f.id).find("._list")[0].innerHTML=b.resultsTemplate.getHTML({items:g,terms:r,totals:j,max:k,min:l}):b.resultsTemplateCallback=function(){$("#"+f.id).find("._list")[0].innerHTML=b.resultsTemplate.getHTML({items:g,terms:r,totals:j,max:k,min:l})},b.pagingTemplate?$("#"+f.id).find("._paging")[0].innerHTML=b.pagingTemplate.getHTML({currentPage:b.currentPage,pages:b.pages}):b.pagingTemplateCallback=function(){$("#"+f.id).find("._paging")[0].innerHTML=b.pagingTemplate.getHTML({currentPage:b.currentPage,pages:b.pages})},$("#"+f.id).find("._list_container")[0].style.display="block",$("#"+f.id).find("._no_results")[0].style.display="none"}else b.loading=!1,$("#"+f.id).find("._list_container")[0].style.display="none",$("#"+f.id).find("._no_results")[0].style.display="block",b.items=[];$("#"+f.id).find("._loading")[0].style.display="none",c.qHyperCube.qSize.qcx<b.fields.length&&b.pageWidth()})})})},b.renderEmpty=function(){b.loading=!1,$("#"+f.id).find("._loading")[0].style.display="none",$("#"+f.id).find("._list_container")[0].style.display="none",$("#"+f.id).find("._no_results")[0].style.display="block",b.items=[]},b.pageWidth=function(){searchExchange.ask(b.handle,"GetLayout",[],function(a){var c=a.qLayout;b.qFields=c.qHyperCube.qDimensionInfo.concat(c.qHyperCube.qMeasureInfo),searchExchange.ask(b.handle,"GetHyperCubeData",["/qHyperCubeDef",[{qTop:b.pageTop,qLeft:10,qHeight:b.config.pagesize,qWidth:b.fields.length}]],function(a){var c=a.qDataPages;b.$apply(function(){c[0].qMatrix.map(function(a,c){for(var d=b.items[c],e=0;e<a.length;e++)d[b.qFields[e].qFallbackTitle]=a[e].qText;return d})})})})},b.applySort=function(a,c){searchExchange.setStateAttr("sort",a),searchExchange.ask(b.handle,"ApplyPatches",[[{qPath:"/qHyperCubeDef/qInterColumnSortOrder",qOp:"replace",qValue:h(a.field)}],!0],function(){c&&1==c&&b.render()})},b.$root.$on("$stateChangeStart",function(a,c,d,e,f){e.name.split(".")[0]==c.name.split(".")[0]&&1==c.name.split(".").length&&searchExchange.state&&searchExchange.state.sort&&b.applySort(searchExchange.state.sort)}),b.$root.$on("$stateChangeSuccess",function(a,b,c,d,e){1==b.name.split(".").length&&searchExchange.state&&(searchExchange.state.page||searchExchange.state.sort)&&searchExchange.render()}),searchExchange.addResults({id:f.id,fields:b.fields,sortOptions:b.sortOptions,defaultSort:h(b.sort.field,!1)},function(a){b.handle=a.handle,b.resultsTemplate||$.get(b.template).success(function(a){b.resultsTemplate=new Templater(a),b.resultsTemplateCallback&&(b.resultsTemplateCallback.call(),b.resultsTemplateCallback=null)}),b.pagingTemplate||$.get("/views/search/search-paging.html").success(function(a){b.pagingTemplate=new Templater(a),b.pagingTemplateCallback&&(b.pagingTemplateCallback.call(),b.pagingTemplateCallback=null)}),b.postponed?b.postponed.call():-1==f.id.indexOf("users.")&&g([a.handle])})}})}],templateUrl:"/views/search/search-results.html"}}]),app.service("userManager",["$resource",function(a){var b=a("system/:path",{path:"@path"});this.menu={},this.userInfo={};var c=this;this.refreshing=!1,this.canUpdateAll=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].allOwners&&1==this.userInfo.role.permissions[a].allOwners},this.canCreate=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].create&&1==this.userInfo.role.permissions[a].create},this.canRead=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].read&&1==this.userInfo.role.permissions[a].read},this.canUpdate=function(a,b){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].update&&1==this.userInfo.role.permissions[a].update?this.userInfo.role.permissions[a].allOwners&&0!=this.userInfo.role.permissions[a].allOwners?!0:this.userInfo._id==b?!0:!1:void 0},this.canApprove=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].approve&&1==this.userInfo.role.permissions[a].approve},this.canFlag=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].flag&&1==this.userInfo.role.permissions[a].flag},this.canHide=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].hide&&1==this.userInfo.role.permissions[a].hide},this.canDelete=function(a,b){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a]["delete"]&&1==this.userInfo.role.permissions[a]["delete"]?this.userInfo.role.permissions[a].allOwners&&0!=this.userInfo.role.permissions[a].allOwners?!0:this.userInfo._id==b?!0:!1:void 0},this.hasUser=function(){return!$.isEmptyObject(c.userInfo)},this.refresh=function(a){this.refreshing=!0,b.get({path:"userInfo"},function(b){c.menu=b.menu,c.userInfo=b.user,a&&a.call(null,c.hasUser())})},this.hasPermissions=function(){return this.userInfo&&this.userInfo.role&&this.userInfo.role.permissions},this.refresh()}]),app.service("resultHandler",["notifications",function(a){this.processing=!1,this.process=function(a,b,c){return a.redirect&&!c?(this.processing||(this.processing=!0,window.location=a.redirect+"?url="+window.location.hash.replace("#/","")),!1):a.errCode?(console.log(a),!1):!0}}]);var SearchExchange=function(){function a(){function a(a,b){for(var c=[],d=0;d<a.length;d++)if(a[d].dimension){var e={qDef:{qFieldDefs:[a[d].dimension]},qNullSuppression:a[d].suppressNull};if(b[a[d].dimension]){var f={};f[b[a[d].dimension].sortType]=b[a[d].dimension].order,e.qDef.qSortCriterias=[f]}c.push(e)}return c}function b(a){for(var b=[],c=0;c<a.length;c++)if(a[c].measure){var d={qDef:{qLabel:a[c].label,qDescription:"",qDef:a[c].measure}};a[c].sortType&&(d.qSortBy={},d.qSortBy[a[c].sortType]=a[c].order),b.push(d)}return b}var c=this;this.seqId=0,this.objects={},this.online=!1,this.clearing=!1,this.priority=[],this.queue=[],this.pendingSearch,this.pendingSuggest,this.state,this.view,this.catalog={},$.ajax({type:"GET",dataType:"text",contentType:"application/json",url:"/configs/sense.json",success:function(a){var b=JSON.parse(a);qsocks.Connect(b).then(function(a){a.openDoc(b.appname).then(function(a){function b(){c.ask(-1,"ProductVersion",[],function(a){}),setTimeout(function(){b()},3e4)}d=a;var e=d.connection.ws.onmessage;d.connection.ws.onmessage=function(a){var b=JSON.parse(a.data);b.suspend?c.publish("resume"):e(a)},c.seqId=d.connection.seqid,c.online=!0,b(),c.publish("online")},function(b){"1002"==b.code?a.getActiveDoc().then(function(a){d=a}):(console.log(b),$rootScope.$broadcast("senseoffline"))})})}}),this.subscribe=function(a,b,d){c.catalog[a]||(c.catalog[a]={}),c.catalog[a][b]&&delete c.catalog[a][b],c.catalog[a][b]={fn:d}},this.unsubscribe=function(a,b){delete c.catalog[a][b]},this.publish=function(a,b,d){if(c.catalog[a])if(c.view&&"online"!=a)for(var e in c.catalog[a])-1!=e.split(".")[0].indexOf(c.view)&&c.catalog[a][e].fn.call(null,b,d);else{var f=0;for(var e in c.catalog[a])c.catalog[a][e].fn.call(null,b,d),f++}},this.subscribe("online","clear",function(){c.clear(!0)}),this.setStateAttr=function(a,b){c.state||(c.state={}),c.state[a]=b},this.matched;var d;this.init=function(a){a&&a.length>0?a.forEach(function(b,d){c.makeSelection(b,function(b){d==a.length-1&&c.lockSelections(function(a){c.executePriority()})},!0)}):c.executePriority()},this.executeQueue=function(){if(c.queue.length>0)for(var a=0;a<c.queue.length;a++)c.queue[a].call(),a==c.queue.length-1&&(c.queue=[],c.online?c.publish("update"):c.subscribe("online","queue",function(){c.publish("update")}));else c.online?c.publish("update"):c.subscribe("online","queue",function(){c.publish("update")})},this.executePriority=function(){c.priority&&c.priority.length>0?c.priority.forEach(function(a,b){a.call(null),
(b=c.priority.length-1)&&(c.priority=[],c.executeQueue())}):c.executeQueue()},this.clear=function(a){this.clearing=!0;c.state=null,d&&(a&&1==a?c.ask(d.handle,"UnlockAll",[],function(a){c.ask(d.handle,"ClearAll",[],function(a){this.clearing=!1,c.publish("reset")})}):c.ask(d.handle,"ClearAll",[],function(a){this.clearing=!1,c.publish("cleared")}))},this.render=function(){c.publish("update")},this.fresh=function(){this.search("")},this.setPage=function(a){this.state||(this.state={}),this.state.page=a-1,this.publish("update")},this.search=function(a,b){c.setStateAttr("searchText",a),c.setStateAttr("searchFields",b),c.publish("searching"),c.terms=a.split(" "),c.seqId++,c.pendingSearch=c.seqId,d.connection.ask(d.handle,"SearchAssociations",[{qContext:"LockedFieldsOnly",qSearchFields:b},c.terms,{qOffset:0,qCount:5,qMaxNbrFieldMatches:5}],c.seqId).then(function(e){e.id==c.pendingSearch&&(""==a||e.result.qResults.qTotalSearchResults>0?c.ask(d.handle,"SelectAssociations",[{qContext:"LockedFieldsOnly",qSearchFields:b},c.terms,0],function(a){c.publish("update",a.change)}):c.publish("noresults",e.change))})},this.suggest=function(a,b){c.seqId++,c.pendingSuggest=c.seqId,d.connection.ask(d.handle,"SearchSuggest",[{qContext:"LockedFieldsOnly",qSearchFields:b},a.split(" ")],c.seqId).then(function(a){a.id==c.pendingSuggest&&c.publish("suggestResults",null,a.result.qResult)})},this.addFilter=function(a,b,e){var f;f=c.objects[a.id]?function(){b.call(null,{handle:c.objects[a.id]})}:function(){var e={qInfo:{qType:"ListObject"},qListObjectDef:{qStateName:"$",qDef:{qFieldDefs:[a.field]},qAutoSortByState:{qDisplayNumberOfRows:8}}};c.seqId++,d.connection.ask(d.handle,"CreateSessionObject",[e],c.seqId).then(function(d){c.objects[a.id]=d.result.qReturn.qHandle,b.call(null,{handle:d.result.qReturn.qHandle})})},c.online?f.call():c.subscribe("online",a.field,f)},this.makeSelection=function(a,b,e){(f=c.objects[a.field])?fn=function(){c.ask(f,"SelectValues",[a.values],function(a){b.call(null,a)})}:fn=function(){c.ask(d.handle,"GetField",[a.field],function(d){c.objects[a.field]=d.result.qReturn.qHandle,c.ask(d.result.qReturn.qHandle,"SelectValues",[a.values],function(a){b.call(null,a)})})},c.online?fn.call():c.subscribe("online",a.field,fn)},c.lockSelections=function(a){fn=function(){c.ask(d.handle,"LockAll",[],function(b){a.call(null)})},c.online?fn.call():c.subscribe("online","lock",fn)},this.addResults=function(e,f,g){c.objects[e.id]?fn=function(){f.call(null,{handle:c.objects[e.id]})}:fn=function(){var g={qInfo:{qType:"table"},qHyperCubeDef:{qDimensions:a(e.fields,e.sortOptions),qMeasures:b(e.fields),qSuppressZero:!1,qSuppressMissing:!1,qInterColumnSortOrder:e.defaultSort}};c.seqId++,d.connection.ask(d.handle,"CreateSessionObject",[g],c.seqId).then(function(a){c.objects[e.id]=a.result.qReturn.qHandle,f.call(null,{handle:a.result.qReturn.qHandle})})},c.online?fn.call():c.subscribe("online",e.id,fn)},this.ask=function(a,b,e,f){c.seqId++,d.connection.ask(a,b,e,c.seqId).then(function(a){f.call(null,a)})}}return a}(),searchExchange=new SearchExchange;app.service("picklistService",["$resource","resultHandler",function(a,b){var c=a("api/picklist/:picklistId",{picklistId:"@picklistId"}),d=a("api/picklistitem/:picklistitemId",{picklistitemId:"@picklistitemId"});this.getPicklistItems=function(a,e){c.get({name:a},function(a){b.process(a)&&a.data&&a.data[0]&&d.get({picklistId:a.data[0]._id},function(a){b.process(a)&&e.call(null,a.data)})})}}]),app.service("publisher",["$rootScope",function(a){var b=this;this.catalog={},this.subscribe=function(a,c,d){b.catalog[a]||(b.catalog[a]={}),b.catalog[a][c]||(b.catalog[a][c]={fn:d})},this.publish=function(a,c){if(b.catalog[a])for(var d in b.catalog[a])b.catalog[a][d].fn.call(null,c)}}]);var Templater=function(){function Templater(a,b){var c=document.createElement("div");c.innerHTML=a,a=c.innerHTML,a=a.replace(/(?:\r\n|\r|\n|\t|\n\t| \n\t)/g,""),a=a.replace(/\s{2,}/g," "),this.pieces=null,this.evalFn=null,this.templateHTML=a,-1!==a.indexOf("qs-repeat=")||-1!==a.indexOf("qs-show=")||-1!==a.indexOf("qs-if=")?this.evalFn=repeater(a):this.pieces=parse(a)}function parse(a){for(var b=/({{([^#^\/].*?)}})/g,c=[];s=b.exec(a);)c.push({what:s[0],item:s[0].replace("{{","").replace("}}","")});return c}function repeater(a){var b=document.createElement("div");b.innerHTML=a;var c=[],d=b.querySelectorAll("[qs-if]");if(d.length>0)for(var e=0;e<d.length;e++){var f=getHTMLString(d[e]),g=d[e].attributes?d[e].attributes["qs-if"].value:null;c.push({type:"qs-if",htmlItem:f,expression:g})}var h=b.querySelectorAll("[qs-repeat]");if(h.length>0)for(var e=0;e<h.length;e++){var f=getHTMLString(h[e]),g=h[e].attributes["qs-repeat"].value.split(" "),i=g[g.length-1],j=g[0]+' in data["'+i+'"]';c.push({type:"qs-repeat",htmlItem:f,dimension:i,repeater:g[0],loop:j,repeatPieces:parse(f)})}var k=b.querySelectorAll("[qs-show]");if(k.length>0)for(var e=0;e<k.length;e++){var f=getHTMLString(k[e]),g=k[e].attributes?k[e].attributes["qs-show"].value:null;c.push({type:"qs-show",htmlItem:f,expression:g})}var l=b.querySelectorAll("[qs-hide]");if(l.length>0)for(var e=0;e<l.length;e++){var f=getHTMLString(l[e]),g=l[e].attributes?l[e].attributes["qs-hide"].value:null;c.push({type:"qs-hide",htmlItem:f,expression:g})}var m=b.querySelectorAll("[qs-ref]");if(m.length>0)for(var e=0;e<m.length;e++){var f=getHTMLString(m[e]),g=m[e].attributes?m[e].attributes["qs-ref"].value:null;c.push({type:"qs-ref",htmlItem:f,expression:g})}return b.innerHTML=null,c}function getRepeatBlock(params,evalIterator,data,iteration){for(var that=this,htmlString=params.htmlItem,i=0;i<params.repeatPieces.length;i++)try{var what=params.repeatPieces[i].what,fields=params.repeatPieces[i].item.split("."),item=what;if(fields[0]==params.repeater){fieldFormatter=fields[fields.length-1].split(":");var df=fieldFormatter[1]||null;if(item=evalIterator,fields.length>1)for(var item=data,ii=1;ii<fields.length;ii++)prop=fields[ii],prop.indexOf(":")&&(prop=prop.split(":")[0]),item&&(item=item[prop]);if(item)if(df)try{var date=new Date(parseInt(item));if("Date"==df)var day=date.getDate(),monthIndex=date.getMonth(),year=date.getFullYear(),output=day+" "+monthNames[monthIndex]+" "+year;if("Time"==df)var output=date.getHours()+":"+(date.getMinutes()<10?"0":"")+date.getMinutes();htmlString=htmlString.replace(what,output)}catch(err){}else htmlString=htmlString.replace(what,highlightText(item,this.terms))}else"$"==fields[0]&&(item=parseInt(evalIterator)+1,item&&(htmlString=htmlString.replace(what,item)))}catch(err){console.log("error",htmlString)}for(var myEval=function(expr){var rootExpr;-1==expr.indexOf("(")&&(rootExpr=expr.split("."),rootExpr.length>1&&rootExpr.splice(0,1),rootExpr=rootExpr.join("."));var s=!0;try{-1!=expr.indexOf("(")?eval("s="+expr):eval("var o=data; if (that.data."+rootExpr+" || data."+rootExpr+" || that.data."+expr+" || data."+expr+" || "+expr+") { s=true; } else { s=false; }")}catch(err){s=!1}finally{}return s},fn=repeater(htmlString),fnAlt=repeater(htmlString),k=0;k<fn.length;k++)if("qs-if"===fn[k].type)myEval(fn[k].expression)===!1&&(fn[k].htmlItem=fn[k].htmlItem.replace(/&amp;/g,"&"),htmlString=htmlString.replace(fn[k].htmlItem,"")),fn=repeater(htmlString);else if("qs-show"===fn[k].type){var show=myEval(fn[k].expression);if(show===!0){if(fn[k].htmlItem=fn[k].htmlItem.replace(/&amp;/g,"&"),-1!=htmlString.indexOf(fn[k].htmlItem)){var str=fn[k].htmlItem.replace("qs-show",'style="display:inherit;" qs-done');htmlString=htmlString.replace(fn[k].htmlItem,str)}fn=repeater(htmlString)}}else if("qs-hide"===fn[k].type){var show=myEval(fn[k].expression);if(show===!0){if(fn[k].htmlItem=fn[k].htmlItem.replace(/&amp;/g,"&"),-1!=htmlString.indexOf(fn[k].htmlItem)){var str=fn[k].htmlItem.replace("qs-hide",'style="display:none;" qs-done');htmlString=htmlString.replace(fn[k].htmlItem,str)}fn=repeater(htmlString)}}else if("qs-ref"===fn[k].type){var loc=window.location.hash.split("?")[0];if(loc+="?"+fn[k].expression,loc=loc.replace(/%22/g,""),fn[k].htmlItem=fn[k].htmlItem.replace(/&amp;/g,"&"),-1!=htmlString.indexOf(fn[k].htmlItem)){var str=fn[k].htmlItem.replace("qs-ref","href="+loc+" qs-done");htmlString=htmlString.replace(fn[k].htmlItem,str)}fn=repeater(htmlString)}if(fnAlt&&fnAlt.length>iteration)for(var j=iteration;j<fnAlt.length;j++)if("qs-repeat"===fnAlt[j].type){htmlString=repeat.call(this,htmlString,fnAlt[j].htmlItem,fnAlt[j],data[fnAlt[j].dimension],j);break}return htmlString}function repeat(a,b,c,d,e){e++;var f="",b=c.htmlItem;if(-1!==a.indexOf(b)){for(var g in d)f+=getRepeatBlock.call(this,c,g,d[g],e);return a.replace(b,f)}return""}function getHTMLString(a){if(!a||!a.tagName)return"";if(a.outerHTML)return a.outerHTML;var b=document.createElement("div");b.appendChild(a.cloneNode(!0));var c=b.innerHTML;return b.innerHTML=null,c}function highlightText(a,b){if(a=a.replace(/<\/?[^>]+(>|$)/g,""),b)for(var c=0;c<b.length;c++)a=a.replace(new RegExp(b[c],"i"),"<span class='highlight"+c+"'>"+b[c]+"</span>");return a}function withinRange(a,b,c,d){var e,f;return 1==c?!1:(2>=b?(e=1,f=d):b>=c-2?(e=c-d,f=c):(e=b-2,f=b+2),a>=e&&f>=a)}Templater.prototype=Object.create(Object.prototype,{getHTML:{value:function(data){var that=this;this.compiledHTML=this.templateHTML,this.data=data,this.terms=data.terms;var myEval=function(expr){var rootExpr=expr.split(".");rootExpr.length>1&&rootExpr.splice(0,1),rootExpr=rootExpr.join(".");var s=!0;try{eval("var o=data; if (that.data."+rootExpr+" || data."+rootExpr+" || that.data."+expr+" || data."+expr+" || "+expr+") { s=true; } else { s=false; }")}catch(err){s=!1}finally{}return s},fn=this.evalFn;if(fn&&fn.length>0){for(var i=0;i<fn.length;i++)if("qs-repeat"===fn[i].type){this.compiledHTML=repeat.call(this,this.compiledHTML,fn[i].htmlItem,fn[i],data[fn[i].dimension],i);break}for(var i=0;i<fn.length;i++)if("qs-show"===fn[i].type){var show=myEval(fn[i].expression)===!0?"inherit":"none";if(fn[i].htmlItem=fn[i].htmlItem.replace(/&amp;/g,"&"),-1!=this.compiledHTML.indexOf(fn[i].htmlItem)){var str=fn[i].htmlItem.replace("qs-show",'style="display:'+show+'" qs-done');this.compiledHTML=this.compiledHTML.replace(fn[i].htmlItem,str)}}else if("qs-hide"===fn[i].type){var show=myEval(fn[i].expression)===!0?"none":"inherit";if(fn[i].htmlItem=fn[i].htmlItem.replace(/&amp;/g,"&"),-1!=this.compiledHTML.indexOf(fn[i].htmlItem)){var str=fn[i].htmlItem.replace("qs-hide",'style="display:'+show+'" qs-done');this.compiledHTML=this.compiledHTML.replace(fn[i].htmlItem,str)}}}this.pieces=parse(this.compiledHTML);for(var i=0;i<this.pieces.length;i++)try{var props=this.pieces[i].item.split("."),result=data;for(var p in props)result=result[props[p]];result&&(this.compiledHTML=this.compiledHTML.replace(this.pieces[i].what,result))}catch(err){console.log("error",data.toString())}return this.compiledHTML}}});var monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return Templater}();app.controller("adminController",["$scope","$resource","$state","$stateParams","userManager","resultHandler","confirm",function(a,b,c,d,e,f,g){var h=b("api/userprofile/:userId",{userId:"@userId"}),i=b("api/project/:projectId",{projectId:"@projectId"}),j=b("api/blog/:blogId",{blogId:"@blogId"}),k=b("api/userrole/:roleId",{roleId:"@roleId"}),l=b("api/feature/:featureId",{featureId:"@featureId"}),m=b("api/picklist/:picklistId",{picklistId:"@picklistId"}),n=b("api/picklistitem/:picklistitemId",{picklistitemId:"@picklistitemId"});a.userManager=e,a.doingStuff=!1,a.collections=["user","userprofile","userrole","feature","project","comment","blog","discussion","picklist","picklistitem","flag","rating","subscription"];h.get({},function(b){f.process(b)&&(a.users=b.data,a.userInfo=b,delete a.userInfo.data)}),k.get({},function(b){f.process(b)&&(a.roles=b.data,a.roleInfo=b,delete a.roleInfo.data,a.setRole(0))}),l.get({},function(b){f.process(b)&&(a.features=b.data,a.featureInfo=b,delete a.featureInfo.data,a.setActiveFeature(0))}),m.get({},function(b){f.process(b)&&(a.picklists=b.data,a.picklistInfo=b,delete a.picklistInfo.data,a.setActivePickList(0))}),a.activeRole=0,a.activePicklist=0,a.activeTab=0,a.activeFeature=0,a.setTab=function(b){a.activeTab=b,searchExchange.clear(!0)},a.setRole=function(b){a.activeRole=b,a.copyRoleName=a.roles[a.activeRole].name},a.setActivePickList=function(b){a.activePicklist=b,a.getPicklistItems(a.picklists[b]._id),a.copyListName=a.picklists[a.activePicklist].name},a.setActiveFeature=function(b){a.activeFeature=b,l.get({_id:a.features[a.activeFeature]._id},function(b){f.process(b)&&b.data&&b.data.length>0&&(a.currentFeature=b.data[0])})},a.saveRole=function(){k.save({roleId:a.roles[a.activeRole]._id},a.roles[a.activeRole],function(b){f.process(b,"Save")&&a.userManager.refresh()})},a.savePicklist=function(){Picklists.save({picklistId:a.picklists[a.activePicklist]._id},a.picklists[a.activePicklist],function(a){f.process(a,"Save")})},a.newRole=function(b){var c=this;k.save({},{name:b},function(b){f.process(b,"Create")&&(a.roles.push(b),c.newrolename="",a.setRole(a.roles.length-1))})},a.newPicklist=function(b){var c=this;m.save({},{name:b},function(b){f.process(b)&&(a.picklists.push(b),c.newlistname="",a.setActivePickList(a.picklists.length-1))})},a.newPicklistItem=function(b){var c=this,d={name:b,picklistId:a.picklists[a.activePicklist]._id,seq:a.picklistItems.length};c.newlistitem="",a.savePicklistItem(d)},a.getPicklistItems=function(b){n.get({picklistId:b},function(b){f.process(b)&&(a.picklistItems=b.data)})},a.savePicklistItem=function(b){n.save({picklistitemId:b._id||""},b,function(b){f.process(b)&&(a.picklistItems?a.picklistItems.push(b):a.picklistItems=[b])})},a.copyRole=function(b){var c=a.roles[a.activeRole];b==c.name&&(b+=" - copy"),k.save({},{name:b,permissions:c.permissions},function(b){f.process(b)&&(a.roles.push(b),a.setRole(a.roles.length-1))})},a.$on("setFeature",function(b,c){a.setFeature(c[0])}),searchExchange.subscribe("setFeature","adminConsole",function(b,c){a.setFeature(b,c)}),a.changeFeatureImage=function(){g.prompt("Would you like to upload an image or enter a url to link to?",{options:["Upload","Link","Cancel"]},function(b){0==b.result||1==b.result&&g.prompt("Please enter a link to an image",{requireComment:!0,options:["Ok","Cancel"]},function(b){0==b.result&&(a.currentFeature.image=b.comment,a.saveFeature())})})},a.setFeature=function(b,c){a.getItem(b,c,function(b){a.currentFeature.entityId=b._id,a.currentFeature.title=b.title,a.currentFeature.comment=b.short_description,a.currentFeature.image=null==b.image?b.thumbnail:b.image,a.currentFeature.userid=b.userid._id,l.save({featureId:a.currentFeature._id},a.currentFeature,function(b){f.process(b)&&a.setActiveFeature(a.activeFeature)})})},a.getItem=function(a,b,c){"project"==a?i.get({projectId:b},function(a){f.process(a)&&a.data&&a.data[0]?c.call(null,a.data[0]):c.call(null,null)}):"blog"==a&&j.get({blogId:b},function(a){f.process(a)&&a.data&&a.data[0]?c.call(null,a.data[0]):c.call(null,null)})},a.saveFeature=function(){l.save({featureId:a.features[a.activeFeature]._id},a.currentFeature,a.features[a.activeFeature],function(b){f.process(b)&&a.setActiveFeature(a.activeFeature)})},a.highlightRow=function(b){return a.features[a.activeFeature].entityId==b?!0:!1},a.deletePicklistItem=function(b){a.doingStuff=!0,n["delete"]({picklistitemId:b},function(b){a.doingStuff=!1,f.process(b)&&a.setActivePickList(a.activePicklist)})},a.movePicklistItem=function(b,c){var d=a.picklistItems[b],e=a.picklistItems[b+c];originalA=d.seq||b,originalB=d.seq||b+c,d.seq||(d.seq=originalA),e.seq||(e.seq=originalB),d.seq+=c,e.seq-=c,n.save({picklistitemId:d._id},d,function(b){f.process(b)&&n.save({picklistitemId:e._id},e,function(b){f.process(b)&&(a.picklistItems.splice(originalA,1),a.picklistItems.splice(originalA+=c,0,d))})})},a.$on("$stateChangeSuccess",function(b,c,d,e,f){"loginsignup"!=c.name&&(searchExchange.view=c.name.split(".")[0]),a.setTab(0)})}]),app.controller("moderatorController",["$scope","$resource","$state","$stateParams","userManager","resultHandler","confirm",function(a,b,c,d,e,f,g){var h=b("api/flag/:flagId",{flagId:"@flagId"}),i=["project","blog","discussion","comment","user"];a.isModerator=!1,a.activeTab=0,a.showComments=!1,a.commentsType,a.commentsTitle,a.comments=[],a.commentsTemplate,a.commentsTemplate||$.get("/views/moderator/moderator-comments.html").success(function(b){a.commentsTemplate=new Templater(b)});var j;a.setTab=function(b){a.activeTab=b,searchExchange.clear()},searchExchange.subscribe("clearFlags","moderatorController",function(a,b){h.save({entityId:b,flagType:a},{flagged:!1},function(a){f.process(a)})}),searchExchange.subscribe("viewComments","moderatorController",function(b,c){a.commentsTitle=b[1];var d=b[0];a.commentType="flag"==b[0]?"Flag":"Spam",h.get({entityId:c,flagType:d,flagged:!0},function(b){f.process(b)&&(document.getElementById("moderator_comments").innerHTML=a.commentsTemplate.getHTML({commentType:a.commentType,commentsTitle:a.commentsTitle,comments:b.data}),document.getElementById("moderator_comments_container").style.display="block")})}),searchExchange.subscribe("closeComments","moderatorController",function(){document.getElementById("moderator_comments").innerHTML="",document.getElementById("moderator_comments_container").style.display="none"}),a.$on("$stateChangeSuccess",function(b,c,d,f,g){if(f.name.split(".")[0]==c.name.split(".")[0]&&1==c.name.split(".").length&&searchExchange.publish("executeSearch"),"loginsignup"!=c.name&&(searchExchange.view=c.name.split(".")[0]),(f.name.split(".")[0]!=c.name.split(".")[0]||"loginsignup"==f.name)&&searchExchange.clear(!0),j=[],e.hasUser()){for(var h=0;h<i.length;h++)e.canApprove(i[h])&&(a.isModerator=!0,j=[{field:"DocType",values:[{qText:i[h]}]}]);searchExchange.subscribe("reset","moderator",function(){searchExchange.init(j),searchExchange.unsubscribe("reset","moderator")}),(f.name.split(".")[0]!=c.name.split(".")[0]||"loginsignup"==f.name)&&searchExchange.clear(!0)}else e.refresh(function(b){if(b)for(var d=0;d<i.length;d++)e.canApprove(i[d])&&(a.isModerator=!0,j=[{field:"DocType",values:[{qText:i[d]}]}]);else window.location="#login?url=moderator";a.isModerator||(window.location="#/"),searchExchange.subscribe("reset","moderator",function(){searchExchange.init(j),searchExchange.unsubscribe("reset","moderator")}),(f.name.split(".")[0]!=c.name.split(".")[0]||"loginsignup"==f.name)&&searchExchange.clear(!0)})}),a.setTab(0)}]),app.controller("authController",["$scope","$resource","$state","$stateParams","userManager","resultHandler","notifications",function(a,b,c,d,e,f,g){var h=b("auth/login"),i=b("auth/signup"),j=b("auth/reset"),k=b("visualcaptcha/try");a.authLoading=!1,a.resetting=!1,d.url&&(a.returnUrl=d.url.replace(/%2F/gi,"")),a.captchaOptions={imgPath:"bower_components/visualcaptcha.angular/img/",captcha:{numberOfImages:4,url:"/visualcaptcha",supportsAudio:!1},init:function(b){a.captcha=b}},a.login=function(){a.authLoading=!0,h.save({username:a.loginusername,password:a.loginpassword},function(b){f.process(b)?(e.refresh(),searchExchange.clear(!0),window.location="#"+a.returnUrl||"/"):(a.authLoading=!1,g.notify(b.errText,null,{sentiment:"negative"}))})},a.signup=function(){if(a.isVisualCaptchaFilled()){var b=$(".imageField")[0],c={};c[$(b).attr("name")]=$(b).attr("value"),a.authLoading=!0,k.save(c,function(b){"valid"==b.status?i.save({username:a.username,password:a.password,email:a.email},function(b){f.process(b)?(e.refresh(),window.location="#"+a.returnUrl||"/"):(a.authLoading=!1,g.notify(b.errText,null,{sentiment:"negative"}))}):(a.authLoading=!1,g.notify("Specified captcha is not correct",null,{sentiment:"negative"}))})}},a.reset=function(){a.resetting=!0,j.save({email:a.email},function(b){f.process(b)?(a.resetting=!1,e.refresh(),a.email="",g.notify("An email has been sent to the specified address.",null,{sentiment:"positive"})):(a.resetting=!1,g.notify(b.errText,null,{sentiment:"negative"}))})},a.isVisualCaptchaFilled=function(){return a.captcha.getCaptchaData().valid?!0:(g.notify("visualCaptcha is NOT filled",null,{sentiment:"warning"}),!1)}}]),app.controller("homeController",["$scope","$resource","$state","$stateParams","userManager","resultHandler",function(a,b,c,d,e,f){var g=b("api/feature/:featureId",{featureId:"@featureId"}),h=b("api/project/:projectId",{projectId:"@projectId"}),i=b("api/blog/:blogId",{blogId:"@blogId"});a.featuredProject={},a.featuredArticle={},g.get({},function(b){if(f.process(b)){a.features=b.data,a.featureInfo=b,delete a.featureInfo.data;for(var c in a.features){a.features[c].entityId;switch(a.features[c].name){case"project":a.featuredProject=a.features[c];break;case"article":a.featuredArticle=a.features[c]}}}}),h.get({sort:"createdate_num",sortOrder:"-1",limit:"3"},function(b){f.process(b)&&(a.latestProjects=b.data)}),i.get({sort:"createdate_num",sortOrder:"-1",limit:"3"},function(b){f.process(b)&&(a.latestArticles=b.data)})}]),app.controller("projectController",["$scope","$resource","$state","$stateParams","$anchorScroll","userManager","resultHandler","confirm","notifications","picklistService",function(a,b,c,d,e,f,g,h,i,j){function k(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return b}var l,m=b("api/project/:projectId",{projectId:"@projectId"}),n=(b("api/picklist/:picklistId",{picklistId:"@picklistId"}),b("api/picklistitem/:picklistitemId",{picklistitemId:"@picklistitemId"}),b("system/git/:path",{path:"@path"})),o=b("api/rating");b("api/rating/rating/my");a.dirtyThumbnail=!1,a.userManager=f,a.Confirm=h,a.isNew="new"==d.projectId,a.projects=[],a.gitProjects=[],a.url="projects",a.searching=!0,a.projectLoading=!a.isNew,a.gitLoading=!1,a.rating={},a.getRate={},a.query={limit:a.pageSize},d.sort&&a.sortOptions[d.sort]&&(a.sort=a.sortOptions[d.sort]),d.projectId&&(a.query.projectId=d.projectId,a.projectId=d.projectId),a.ratingClick=function(){if(a.rate&&!a.isReadonly){a.isReadonly=!0,a.query.votenum=a.projects[0].votenum+1,a.query.votetotal=a.projects[0].votetotal+a.rate,a.updateProjectData(a.query),a.rating.id=a.projects[0]._id,a.rating.userid=d.userId,a.rating.rate=a.rate,a.rating.date=new Date;var b={entityId:a.rating.id,userid:a.rating.userid,createdate:a.rating.date,rating:a.rating.rate};a.saveRating(b)}},a.getProductVersions=function(b){j.getPicklistItems(b.name+" Version",function(b){a.productVersions=b})},a.getProjectData=function(b,c){a.projectLoading=!0,m.get(b,function(b){g.process(b)&&(a.projectLoading=!1,b.data&&b.data.length>0?c&&1==c?a.projects=a.projects.concat(b.data):a.projects=b.data:window.location="#noitem",d.status&&("created"==d.status?i.notify("Your project has been successfully submitted for approval.",null,{sentiment:"positive"}):"updated"==d.status&&i.notify("Your project has been successfully updated. It may take up to 5 minutes for the listing page to reflect these changes.",null,{sentiment:"positive"})),a.projects.forEach(function(b,c){if(b.votenum>0){var d=Math.round(b.votetotal/b.votenum);a.projects[c].stars=new Array(d)}}),a.projectInfo=b,delete a.projectInfo.data,a.getProductVersions(a.projects[0].product))})},a.getRating=function(a,b){return b&&b>0?Math.round(parseInt(a)/parseInt(b)):0},a.updateProjectData=function(a){m.save(a,function(a){g.process(a)})},a.saveRating=function(a){o.save(a,function(a){g.process(a)})},a.getBuffer=function(a){return k(a)},a.getPageText=function(){return a.projects[0]&&a.projects[0].content?marked(a.projects[0].content):void 0},a.applySort=function(){window.location="#project?sort="+a.sort.id+"&product="+a.productId+"&category="+a.categoryId},a.getGitProjects=function(b,c){a.gitLoading=!0,a.gitError=null;var d={user:b,password:c};n.save({path:"projects"},d,function(b){if(g.process(b))a.gitLoading=!1,a.gitProjects=b.repos;else{var c;try{var c=JSON.parse(b.errText);a.gitError=c.message}catch(d){a.gitError=b.errText}a.gitLoading=!1}})},a.selectGitProject=function(b){a.projects[0].project_site=b.html_url,a.projects[0].git_clone_url=b.clone_url,a.projects[0].git_repo=b.name,a.projects[0].git_user=b.owner.login,a.projects[0].download_link="https://github.com/"+b.owner.login+"/"+b.name+"/zipball/master"},a.checkIfVersionChecked=function(b){return a.projects[0]&&a.projects[0].productversions?-1!=a.projects[0].productversions.indexOf(b):!1},a.previewThumbnail=function(){a.dirtyThumbnail=!0;var b=$("#thumbnail")[0].files[0],c=b.name,d=b.type,e=new FileReader;e.onloadend=function(b){var f=document.createElement("canvas"),g=f.getContext("2d"),h=document.createElement("canvas"),i=h.getContext("2d"),j=new Image;j.onload=function(){var b=j.width,e=j.height;f.width=b,f.height=e,h.width=b*(77/e),h.height=77,g.drawImage(j,0,0,f.width,f.height),a.image={type:d,name:c,data:f.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},i.drawImage(j,0,0,h.width,h.height),a.thumbnail={type:d,name:c,data:h.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},a.$apply(function(){a.projects[0].thumbnail=h.toDataURL()})},j.src=e.result},e.readAsDataURL(b)},a.validateNewProjectData=function(){var b=[];a.projects[0].title&&""!=a.projects[0].title||b.push("Please specify a Name"),a.projects[0].short_description&&""!=a.projects[0].short_description||b.push("Please add a Short Description"),a.projects[0].category||b.push("Please select a Project Type"),a.projects[0].status||b.push("Please select a Project Status"),a.projects[0].product||b.push("Please select a Product"),a.projects[0].product&&0==$(".product-version:checkbox:checked").length&&b.push("Please specify at least one Product Version"),a.isNew&&!a.projects[0].git_repo&&b.push("Please select a Git project to use"),"false"!=a.usegit||$("#newProjectContent").code()||b.push("Please add some content to the project (e.g. documentation, installation instructions)."),b.length>0?(i.notify("The project could not be saved. Please review the following...",b,{sentiment:"warning"}),window.scrollTo(100,0)):a.saveNewProject()},a.saveNewProject=function(){var b=[];a.projectLoading=!0,$(".product-version:checkbox:checked").each(function(c,d){b.push($(this).attr("data-versionid")),c==$(".product-version:checkbox:checked").length-1&&(a.projects[0].productversions=b)});var c={standard:a.projects[0]};a.dirtyThumbnail&&(c.special={image:a.image,thumbnail:a.thumbnail});var d={};a.projects[0]._id&&(d.projectId=a.projects[0]._id),m.save(d,c,function(b){if(a.projectLoading=!1,g.process(b)){var c=a.isNew?"created":"updated";window.location="#project/"+b._id+"?status="+c}else i.notify(b.errText,null,{sentiment:"negative"})})},a.search=function(){searchExchange.clear(),a.searching=!0},a.browse=function(){searchExchange.clear(),a.searching=!1},a.clear=function(){searchExchange.clear()},a.removedefaultSelection=function(a){for(var b=0;b<l.length;b++)l[b].field==a&&l.splice(b,1)},a.filterProduct=function(b){a.removedefaultSelection("product"),"QlikView"==b?($(".qlikview-filter").hasClass("active")?$(".qlikview-filter").removeClass("active"):($(".qlikview-filter").addClass("active"),a.addDefaultSelection("product",[{qText:b}])),$(".qlik-sense-filter").removeClass("active")):($(".qlik-sense-filter").hasClass("active")?$(".qlik-sense-filter").removeClass("active"):($(".qlik-sense-filter").addClass("active"),a.addDefaultSelection("product",[{qText:b}])),$(".qlikview-filter").removeClass("active")),searchExchange.subscribe("reset","projects",function(){searchExchange.init(l),searchExchange.unsubscribe("reset","projects")}),searchExchange.clear(!0)},a.addDefaultSelection=function(a,b){l.push({field:a,values:b})},a.$on("$stateChangeSuccess",function(b,e,g,h,i){if(h.name.split(".")[0]==e.name.split(".")[0]&&1==e.name.split(".").length&&searchExchange.publish("executeSearch"),"loginsignup"!=e.name&&(searchExchange.view=e.name.split(".")[0]),(h.name.split(".")[0]!=e.name.split(".")[0]||"loginsignup"==h.name)&&searchExchange.clear(!0),l=[],"projects.detail"==c.current.name)a.getProjectData(a.query),f.refresh(function(b){a.currentuserid=f.userInfo._id});else if("projects.addedit"==c.current.name){j.getPicklistItems("Product",function(b){a.projectProducts=b}),j.getPicklistItems("Category",function(b){a.projectCategories=b}),j.getPicklistItems("Project Status",function(b){a.projectStatuses=b}),"new"==d.projectId&&(a.projects=[{}]);var k=f.hasUser();k?"new"!=d.projectId&&a.getProjectData(a.query):f.refresh(function(b){b?"new"!=d.projectId&&a.getProjectData(a.query):window.location="#login?url=project/"+d.projectId+"/edit"})}else f.hasUser()?(f.canApprove("project")||(l=[{field:"approved",values:[{qText:"True"}]}]),searchExchange.subscribe("reset","projects",function(){searchExchange.init(l),searchExchange.unsubscribe("reset","projects")}),(h.name.split(".")[0]!=e.name.split(".")[0]||"loginsignup"==h.name)&&searchExchange.clear(!0)):f.refresh(function(a){a?f.canApprove("project")||(l=[{field:"approved",values:[{qText:"True"}]}]):l=[{field:"approved",values:[{qText:"True"}]}],searchExchange.subscribe("reset","projects",function(){searchExchange.init(l),searchExchange.unsubscribe("reset","projects")}),(h.name.split(".")[0]!=e.name.split(".")[0]||"loginsignup"==h.name)&&searchExchange.clear(!0)})})}]),app.controller("blogController",["$scope","$resource","$state","$stateParams","userManager","resultHandler","notifications","picklistService",function(a,b,c,d,e,f,g,h){function i(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return b}function j(a){var b=a.replace(/<img[^>]*>/g,"[image]");return noHTML=b.replace(/<\/?[^>]+(>|$)/g,""),noHTML}var k=b("api/blog/:blogId",{blogId:"@blogId"});a.pageSize=20,a.query={},a.blogLoading="new"!=d.blogId,a.isNew="new"==d.blogId,a.dirtyThumbnail=!1;var l;a.blogTypes,d.blogId&&(a.query.blogId=d.blogId,a.blogId=d.blogId),h.getPicklistItems("Blog Type",function(b){a.blogTypes=b,a.newBlogType=b[0]}),a.getBlogData=function(b,e){k.get(b,function(b){a.blogLoading=!1,f.process(b)&&(b.data&&b.data.length>0?(d.status&&("created"==d.status?g.notify("Your blog post has been successfully submitted for approval.",null,{sentiment:"positive"}):"updated"==d.status&&g.notify("Your blog post has been successfully updated. It may take up to 5 minutes for the listing page to reflect these changes.",null,{sentiment:"positive"})),e&&1==e?a.blogs=a.blogs.concat(b.data):a.blogs=b.data,"blogs.addedit"==c.current.name&&$("#blogContent").code(i(b.data[0].content.data)),a.blogInfo=b,delete a.blogInfo.data):window.location="#noitem")})},a.previewThumbnail=function(){a.dirtyThumbnail=!0;var b=$("#blogImage")[0].files[0],c=b.name,d=b.type,e=new FileReader;e.onloadend=function(b){var f=document.createElement("canvas"),g=f.getContext("2d"),h=document.createElement("canvas"),i=h.getContext("2d"),j=new Image;j.onload=function(){var b=j.width,e=j.height;f.width=b,f.height=e,h.width=b*(77/e),h.height=77,g.drawImage(j,0,0,f.width,f.height),a.image={type:d,name:c,data:f.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},i.drawImage(j,0,0,h.width,h.height),a.thumbnail={type:d,name:c,data:h.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},a.$apply(function(){a.blogs[0].thumbnail=h.toDataURL()})},j.src=e.result},e.readAsDataURL(b)},a.validateNewBlogData=function(){var b=[];a.blogs[0].title&&""!=a.blogs[0].title||b.push("Please specify a title"),a.blogs[0].short_description&&""!=a.blogs[0].short_description||b.push("Please specify a short description"),a.blogs[0].blogType||b.push("Please select a Type"),(0==$("#blogContent").code().length||12==$("#blogContent").code().length)&&b.push("Please add some content"),b.length>0?(g.notify("The blog post could not be saved. Please review the following...",b,{sentiment:"warning"}),window.scrollTo(100,0)):a.saveBlog()},a.saveBlog=function(){a.blogLoading=!0,a.blogs[0].content=$("#blogContent").code(),a.blogs[0].plaintext=j(a.blogs[0].content);var b={standard:a.blogs[0]};a.dirtyThumbnail&&(b.special={image:a.image,thumbnail:a.thumbnail});var c={};a.blogs[0]._id&&(c.blogId=a.blogs[0]._id),
k.save(c,b,function(b){if(a.blogLoading=!1,f.process(b)){var c=a.isNew?"created":"updated";window.location="#blog/"+b._id+"?status="+c}else g.notify(b.errText,null,{sentiment:"negative"})})},a.getBlogContent=function(a){if(a&&a.data){var b=i(a.data);return marked(b)}return""},a.$on("$stateChangeSuccess",function(b,f,g,i,j){if(i.name.split(".")[0]==f.name.split(".")[0]&&1==f.name.split(".").length&&searchExchange.publish("executeSearch"),"loginsignup"!=f.name&&(searchExchange.view=f.name.split(".")[0]),(i.name.split(".")[0]!=f.name.split(".")[0]||"loginsignup"==i.name)&&searchExchange.clear(!0),l=[],"blogs.detail"==c.current.name)a.getBlogData(a.query),e.refresh(function(b){a.currentuserid=e.userInfo._id});else if("blogs.addedit"==c.current.name){$("#blogContent").summernote({height:400}),h.getPicklistItems("Blog Type",function(b){a.blogTypes=b}),"new"==d.blogId&&(a.blogs=[{}]);var k=e.hasUser();k?"new"!=d.blogId&&a.getBlogData(a.query):e.refresh(function(b){b?"new"!=d.blogId&&a.getBlogData(a.query):window.location="#login?url=blog/"+d.blogId+"/edit"})}else e.hasUser()?(e.canApprove("blog")||(l=[{field:"approved",values:[{qText:"True"}]}]),searchExchange.subscribe("reset","blogs",function(){searchExchange.init(l),searchExchange.unsubscribe("reset","blogs")}),(i.name.split(".")[0]!=f.name.split(".")[0]||"loginsignup"==i.name)&&searchExchange.clear(!0)):e.refresh(function(a){a?e.canApprove("blog")||(l=[{field:"approved",values:[{qText:"True"}]}]):l=[{field:"approved",values:[{qText:"True"}]}],searchExchange.subscribe("reset","blogs",function(){searchExchange.init(l),searchExchange.unsubscribe("reset","blogs")}),(i.name.split(".")[0]!=f.name.split(".")[0]||"loginsignup"==i.name)&&searchExchange.clear(!0)})})}]),app.controller("discussionController",["$scope","$resource","$state","$stateParams","userManager","resultHandler","notifications","picklistService",function(a,b,c,d,e,f,g,h){function i(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return b}function j(a){var b=a.replace(/<img[^>]*>/g,"[image]");return noHTML=b.replace(/<\/?[^>]+(>|$)/g,""),noHTML}var k=b("api/discussion/:discussionId",{discussionId:"@discussionId"});a.pageSize=20,a.query={},a.canAnswer=!1,a.canReopen=!1,a.discussions=[],a.discussionLoading="new"!=d.discussionId,a.isNew="new"==d.discussionId;var l;-1!=c.current.name.indexOf("addedit")?(a.threadHeading="new"==d.discussionId?"New Thread":"Edit Thread",a.discussions=[{}],$("#discussionContent").summernote({height:400})):(a.discussionId=d.discussionId,a.query.discussionId=a.discussionId),a.markAnswered=function(b){var c=a.getStatusId("Answered");c?(a.discussionLoading=!0,k.save({discussionId:b},{status:c},function(b){a.discussionLoading=!1,f.process(b)?(a.canAnswer=!1,a.canReopen=!0):g.notify(b.errText,null,{sentiment:"negative"})})):g.notify("Could not mark discussion as answered. Please contact the Branch admin team.",null,{sentiment:"negative"})},a.reOpen=function(b){var c=a.getStatusId("Unanswered");c?(a.discussionLoading=!0,k.save({discussionId:b},{status:c},function(b){a.discussionLoading=!1,f.process(b)?(a.canAnswer=!0,a.canReopen=!1):g.notify(b.errText,null,{sentiment:"negative"})})):g.notify("Could not reopen discussion. Please contact the Branch admin team.",null,{sentiment:"negative"})},a.getStatusId=function(b){for(var c=0;c<a.discussionStatus.length;c++)if(a.discussionStatus[c].name==b)return a.discussionStatus[c]._id;return null},a.validateNewDiscussionData=function(){var b=[];a.discussions[0].title&&""!=a.discussions[0].title||b.push("Please specify a title"),a.discussions[0].tags&&""!=a.discussions[0].tags||b.push("Please specify at least one tag"),12==$("#discussionContent").code().length&&b.push("Please add some content"),b.length>0?(g.notify("The discussion could not be saved. Please review the following...",b,{sentiment:"warning"}),window.scrollTo(100,0)):a.saveDiscussion()},a.saveDiscussion=function(){a.discussionLoading=!0,a.discussions[0].content=$("#discussionContent").code(),a.discussions[0].plaintext=j(a.discussions[0].content);var b={};a.discussions[0]._id&&(b.discussionId=a.discussions[0]._id),k.save(b,a.discussions[0],function(b){if(a.discussionLoading=!1,f.process(b)){var c=a.isNew?"created":"updated";window.location="#discussion/"+b._id+"?status="+c}else g.notify(b.errText,null,{sentiment:"negative"})})},a.getDiscussionData=function(b,e){k.get(b,function(b){a.discussionLoading=!1,f.process(b)&&(b.data&&b.data.length>0?(d.status&&("created"==d.status?g.notify("Your discussion has been successfully created.",null,{sentiment:"positive"}):"updated"==d.status&&g.notify("Your discussion has been successfully updated. It may take up to 5 minutes for the listing page to reflect these changes.",null,{sentiment:"positive"})),e&&1==e?a.discussions=a.discussions.concat(b.data):a.discussions=b.data,"forum.addedit"==c.current.name&&$("#discussionContent").code(i(b.data[0].content.data)),a.discussionInfo=b,a.canAnswer=a.discussions[0].userid._id==a.currentuserid&&"Unanswered"==a.discussions[0].status.name,a.canReopen=a.discussions[0].userid._id==a.currentuserid&&"Answered"==a.discussions[0].status.name,delete a.discussionInfo.data):window.location="#noitem")})},a.getDiscussionContent=function(a){if(a&&a.data){var b=i(a.data);return marked(b)}return""},a.$on("$stateChangeSuccess",function(b,f,g,i,j){if(i.name.split(".")[0]==f.name.split(".")[0]&&1==f.name.split(".").length&&searchExchange.publish("executeSearch"),"loginsignup"!=f.name&&(searchExchange.view=f.name.split(".")[0]),(i.name.split(".")[0]!=f.name.split(".")[0]||"loginsignup"==i.name)&&searchExchange.clear(!0),l=[],"forum.detail"==c.current.name)h.getPicklistItems("Discussion Status",function(b){a.discussionStatus=b}),e.refresh(function(b){a.currentuserid=e.userInfo._id,a.getDiscussionData(a.query)});else if("forum.addedit"==c.current.name){h.getPicklistItems("Discussion Status",function(b){a.discussionStatus=b});var k=e.hasUser();k?"new"!=d.discussionId&&a.getDiscussionData(a.query):e.refresh(function(b){b?"new"!=d.discussionId&&a.getDiscussionData(a.query):window.location="#login?url=discussion/"+d.discussionId+"/edit"})}else e.hasUser()?(e.canApprove("discussion")||(l=[{field:"approved",values:[{qText:"True"}]}]),searchExchange.subscribe("reset","forum",function(){searchExchange.init(l),searchExchange.unsubscribe("reset","forum")}),(i.name.split(".")[0]!=f.name.split(".")[0]||"loginsignup"==i.name)&&searchExchange.clear(!0)):e.refresh(function(a){a?e.canApprove("discussion")||(l=[{field:"approved",values:[{qText:"True"}]}]):l=[{field:"approved",values:[{qText:"True"}]}],searchExchange.subscribe("reset","forum",function(){searchExchange.init(l),searchExchange.unsubscribe("reset","forum")}),(i.name.split(".")[0]!=f.name.split(".")[0]||"loginsignup"==i.name)&&searchExchange.clear(!0)})})}]),app.controller("commentController",["$scope","$resource","$state","$stateParams","userManager","resultHandler",function(a,b,c,d,e,f){function g(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return b}function h(a){var b=a.replace(/<img[^>]*>/g,"[image]");return noHTML=b.replace(/<\/?[^>]+(>|$)/g,""),noHTML}var i=b("api/comment/:commentId",{commentId:"@commentId"});b("api/"+a.entity+"/"+a.entityid+"/:path",{path:"@path"});a.userManager=e,$("#summernote").summernote({height:100}),a.comments=[],a.pageSize=10,a.sortOptions={newest:{id:"newest",name:"Newest",order:-1,field:"createdate"},oldest:{id:"oldest",name:"Oldest",order:1,field:"createdate"}},a.getFlagged=function(){i.get({commentId:"flagged",entityId:a.entityid},{limit:100},function(b){if(f.process(b)&&b.data)for(var c=0;c<b.data.length;c++)a.flagged[b.data[c].entityId]=!0})},a.getFlagged(),a.isFlagged=function(b){if(a.flagged){for(var c=0;c<a.flagged.length;c++)if(a.flagged[c].entityId==b)return!0;return!1}return!1},a.commentQuery={limit:a.pageSize},a.applySort=function(b){a.commentQuery.sort=b.field,a.commentQuery.sortOrder=b.order,a.getCommentData(a.commentQuery)},a.sort=a.sortOptions.newest,a.commentQuery.sort=a.sort.field,a.commentQuery.sortOrder=a.sort.order,a.$on("listItemDeleted",function(b,c){for(var d=0;d<a.comments.length;d++)a.comments[d]._id==c&&a.comments.splice(d,1)}),a.getCommentData=function(b,c){i.get(b,function(b){f.process(b,null,!0)&&(c&&1==c?a.comments=a.comments.concat(b.data):a.comments=b.data,a.commentInfo=b,delete a.commentInfo.data)})},a.entityid&&(a.commentQuery.entityId=a.entityid,a.url=a.entity+"/"+a.entityId,a.getCommentData(a.commentQuery)),a.getCommentText=function(a){if(a&&a.data){var b=g(a.data);return marked(b)}return""},a.saveComment=function(){var b=$("#summernote").code();i.save({},{entityId:a.entityid,entity:a.entity,content:b,plaintext:h(b)},function(b){f.process(b)&&($("#summernote").code(""),a.getCommentData(a.commentQuery))})},a.more=function(){a.commentQuery.skip=a.comments.length,a.getCommentData(a.commentQuery,!0)}}]),app.controller("userController",["$scope","$resource","$state","$stateParams","userManager","resultHandler","notifications",function(a,b,c,d,e,f,g){var h=b("api/userprofile/:userId",{userId:"@userId"}),i=b("api/project/:projectId",{projectId:"@projectId"}),j=b("api/blog/:blogId",{projectId:"@blogId"}),k=b("auth/change");a.query={},a.projectCount=0,a.userLoading=!0;var l=[];d.userId&&(a.query.userId=d.userId,i.get({projectId:"count",userid:d.userId},function(b){f.process(b)&&(a.projectCount=b.count)}),j.get({blogId:"count",userid:d.userId},function(b){f.process(b)&&(a.blogCount=b.count)})),a.changePassword=function(){k.save({oldPassword:a.oldpassword,password:a.password},function(b){f.process(b)?(a.oldpassword="",a.password="",a.confirm="",g.notify("Your password was successfully changed. ",null,{sentiment:"positive"})):g.notify(b.errText,null,{sentiment:"negative"})})},a.getUserData=function(b,c){h.get(b,function(b){a.userLoading=!1,f.process(b)&&(c&&1==c?a.users=a.users.concat(b.data):a.users=b.data,a.userInfo=b,delete a.userInfo.data)})},a.activeTab=0,a.firstLoad=!0,a.setTab=function(b){a.activeTab=b,a.firstLoad||searchExchange.clear()},a.$on("$stateChangeSuccess",function(b,c,f,g,h){g.name.split(".")[0]==c.name.split(".")[0]&&1==c.name.split(".").length&&searchExchange.publish("executeSearch"),"loginsignup"!=c.name&&(searchExchange.view=c.name.split(".")[0]),(g.name.split(".")[0]!=c.name.split(".")[0]||"loginsignup"==g.name)&&searchExchange.clear(!0),l=[],"users"==c.name||"users.detail"==c.name?(e.refresh(function(b){b?e.canApprove("project")||e.userInfo._id==d.userId||l.push({field:"approved",values:[{qText:"True"}]}):l.push({field:"approved",values:[{qText:"True"}]}),l.push({field:"userId",values:[{qText:d.userId}]}),searchExchange.subscribe("reset","users",function(){searchExchange.init(l),searchExchange.unsubscribe("reset","users")}),a.firstLoad=!1}),a.getUserData(a.query)):("users.addedit"==c.name||"userprofiles.addedit"==c.name)&&e.refresh(function(b){b?"new"!=d.userId&&a.getUserData(a.query):window.location="#login?url=user/"+d.userId+"/edit"})}),a.previewThumbnail=function(){a.dirtyThumbnail=!0;var b=$("#userImage")[0].files[0],c=b.name,d=b.type,e=new FileReader;e.onloadend=function(b){var f=document.createElement("canvas"),g=f.getContext("2d"),h=document.createElement("canvas"),i=h.getContext("2d"),j=new Image;j.onload=function(){var b=j.width,e=j.height;f.width=b,f.height=e,h.width=b*(77/e),h.height=77,g.drawImage(j,0,0,f.width,f.height),a.image={type:d,name:c,data:f.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},i.drawImage(j,0,0,h.width,h.height),a.thumbnail={type:d,name:c,data:h.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},a.$apply(function(){a.users[0].thumbnail=h.toDataURL()})},j.src=e.result},e.readAsDataURL(b)},a.validateNewUserData=function(){var b=[];a.users[0].fullname&&""!=a.users[0].fullname||b.push("Please tell us your name"),b.length>0?(g.notify("The blog post could not be saved. Please review the following...",b,{sentiment:"warning"}),window.scrollTo(100,0)):a.saveUser()},a.saveUser=function(){a.userLoading=!0;var b={standard:a.users[0]};a.dirtyThumbnail&&(b.special={image:a.image,thumbnail:a.thumbnail});var c={};a.users[0]._id&&(c.userId=a.users[0]._id),h.save(c,b,function(b){if(a.userLoading=!1,f.process(b)){var c=a.isNew?"created":"updated";window.location="#user/"+b._id+"?status="+c}else g.notify(b.errText,null,{sentiment:"negative"})})}}]),app.controller("moderationController",["$scope","$rootScope","$resource","$state","$stateParams","userManager","resultHandler","confirm",function(a,b,c,d,e,f,g,h,i){var j=c("/api/"+a.entity+"/:entityId/:function",{entityId:"@entityId","function":"@function"});a.userManager=f,a.isApproved=function(){return"True"==a.approved||1==a.approved},a.flagEntity=function(b){h.prompt("Please provide a comment for this action.",{requireComment:!0,options:["Ok","Cancel"]},function(c){var d=1==a.flagged?"unflag":"flag";0==c.result&&j.save({entityId:a.entityid,"function":d},{comment:c.comment,flagType:b},function(b){g.process(b)&&(a.flagged=!a.flagged)})})},a.hideEntity=function(){h.prompt("Please enter a reason for unapproving the item. An email will be sent to the owner so try not to be too harsh.",{requireComment:!0,options:["Send","Cancel"]},function(b){0==b.result&&j.save({entityId:a.entityid,"function":"hide",hideComment:b.comment},function(b){g.process(b)&&(a.approved="False")})})},a.approveEntity=function(){j.save({entityId:a.entityid,"function":"approve"},function(b){g.process(b)&&(a.approved="True")})},a.editEntity=function(){window.location="#"+a.entity+"/"+a.entityid+"/edit"},a.deleteEntity=function(){h.prompt("Are you sure you want to delete the selected item?",{options:["Yes","No"]},function(c){0==c.result&&j["delete"]({entityId:a.entityid},function(c){g.process(c)&&("comment"!=a.entity&&(window.location="#"+a.entity),b.$broadcast("listItemDeleted",a.entityid))})})},f.hasUser()?a.hasUser=!0:f.refresh(function(b){b?a.hasUser=!0:a.hasUser=!1})}]);